# 一、电机原理

## 1.1 直流电机

<div><img src="https://cdn.jsdelivr.net/gh/lcekold/blogimage@main/Network/Snipaste_2025-03-09_22-15-05.png"></div>

直流电机非常简单,一端通正极,一端通负极,电机就可以旋转,电压越大,旋转也就越快,将正负极反过来,电机还可以反转

这种小直流电机往往需要几百毫安的电流,只能提供几毫安电流的GPLO口可承受不住,而且电机内线圈转动时,切割磁感线以及电机内转子线圈的电感效应,都会产生反电动势,当电机停转换向或者我们手动转动电机时,较高的电压进入到STM32芯片中,极有可能损坏STM32芯片

## 1.2 电机驱动芯片(以DRV8833为例)

### 1.2.1 电机驱动芯片引脚说明
那该如何使用STM32驱动电机呢,电机驱动芯片就是为解决此问题而生的。

在DRV8833驱动板的背面,小伙伴们可以看到四个in口以及四个out口,其中IN1、IN2与OUT1、OUT2是一组,我们可以通过单片机输出PWM到in1、in2,来控制out1与OUT2的输出,进而控制电机的旋转,In3、in4,OUT3、OUT4也是一样,也就是说,一颗DRV8833驱动芯片,可以同时驱动两个电机

sleep引脚可以让芯片暂停工作,实现低功耗,fault脚可以在出现控制错误时,提醒单片机

VCC与GND引脚用于给芯片和电机供电

### 1.2.2 电机驱动芯片控制方式
当STM32向IN1输入高电平,向IN2输入低电平时,OUT1、OUT2就会分别输出高电平与低电平,使电机正转,当将INT1、INT2的输入反过来时,OUT1与OUT2的输出也会反过来,也就是反转。

### 1.2.3 慢衰减

这很简单,当电机在旋转时,我们将两个in口的输入都变为高电平,两个out口就会都输出低电平,相当于电机的两根线短路,而我们小学二年级时就知道,电机内的转子其实有很多线圈组成,相当于是一个电感,电感会产生反电动势,阻碍电流的变化,因而此时电流在整个回路中是逐渐缓慢的变小,消失的,因而这种情况下我们称为慢衰减

不过由于反电动势产生的磁场,与电子的磁场相互作用,会使得电机的转子比较快的刹停下来,因而我们也称这种情况为刹车

### 1.2.4 快衰减
另一种情况,当电机在旋转时,我们将两个IN口的输入都变为低电平,此时第二位8833,会短暂的将out1与out2的输出反转,使得转子电感的电流被瞬间释放掉,随后OUT1、OUT2就会被断路,由于电流被瞬间释放,因而这种情况我们称为快衰减。

而且断路后电机转子无法形成回路,不会产生电流与磁场,因而转子会随惯性继续转动,直到由于摩擦力慢慢降速下来,因而这种情况我们也称为滑行

衰减是指电流衰减,而不是速度,速度正好相反,慢衰减下快速刹车,快衰减下慢慢减速

<div><img src="https://cdn.jsdelivr.net/gh/lcekold/blogimage@main/Network/Snipaste_2025-03-10_17-51-15.png"></div>

### 1.2.5 如何控制电机的转速

假设我们将正转状态下的高电平in1,替换为PWM信号,那电机不就一会儿处于正转状态,一会儿处于滑行状态,这样当我们PWM中占空比越高时,正转的时间也就越长,宏观上来看,转动的速度也就越快,对于反向旋转来说,我们将in2的高电平替换为PWM,也可以实现一样的效果,占空比越大,转速越快,这种靠转动和滑动交替进行调速的方法,我们也称为快衰减

除了快衰减的方案,我们也可以将正转状态下的低电平,in2替换为PWM信号,这样电机也就在正转与刹车之间进行切换,也可以实现调速,不过区别是这种状态下PWM的低电平为正转,因而占空比越小时转速越快,同样的反向旋转也是如此,这种靠转动与刹车交替调速的方法,我们也称为慢衰减

由于快衰减模式能够迅速降低电流,因而常用在需要快速变化的高动态响应场景中,而脉衰减模式电流变化比较平稳,因而比较适合用于平稳运行,降低噪音的场景中

<div><img src="https://cdn.jsdelivr.net/gh/lcekold/blogimage@main/Network/Snipaste_2025-03-10_17-54-06.png"></div>

<div><img src="https://cdn.jsdelivr.net/gh/lcekold/blogimage@main/Network/Snipaste_2025-03-10_17-54-49.png"></div>

# 二、代码示例：通过旋转编码器调节PWM控制电机来转动风扇

## 2.1 cubemx配置

### 2.1.1 配置PWM

<div><img src="https://cdn.jsdelivr.net/gh/lcekold/blogimage@main/Network/Snipaste_2025-03-10_20-35-29.png"></div>

### 2.1.2 配置编码器

<div><img src="https://cdn.jsdelivr.net/gh/lcekold/blogimage@main/Network/Snipaste_2025-03-10_20-36-18.png"></div>

